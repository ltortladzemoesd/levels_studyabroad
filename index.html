<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Levels Academy – Europe (Screen-constant Labels)</title>

<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://unpkg.com/@mapbox/polylabel@1.1.0/polylabel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@700&display=swap" rel="stylesheet"/>

<style>
  :root{
    --sea:#BBE0F9; --land:#ffffff; --border:#cfd6dc; --hover:#23B899;
    --brand:#2B445B; --ink:#0f1f29; --muted:#6b7a86;
    --t1:#23B899; --t2:#FDE200; --t3:#F66E6E;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,Arial}
  .app{display:grid;grid-template-columns:1.5fr .9fr;height:100vh; position:relative}
  .app.closed{grid-template-columns:1fr 0}
  .map-wrap{background:var(--sea); position:relative; grid-column:1 / -1;}
  svg{width:100%;height:100%}
  .country{fill:var(--land);stroke:var(--border);stroke-width:1;cursor:pointer;transition:fill .12s ease}
  .country:hover{fill:var(--hover)}
  .country.selected{fill:var(--hover) !important;}
  .label{ fill:#333333; font-family:'Red Hat Display', ui-sans-serif, system-ui, Arial; font-weight:700; letter-spacing:.3px; pointer-events:none; }
  .rest{fill:#F7FAFF; stroke:var(--border); stroke-width:1}
  .panel{background:#fff;border-left:1px solid #e9eef2;display:flex;flex-direction:column}
  .app.closed .panel{display:none}
  .panel-head{background:var(--brand);color:#fff;padding:14px 16px;display:flex;justify-content:space-between;align-items:center}
  .panel-title{font-weight:800}
  .panel-count{opacity:.9}
  .list{padding:12px;overflow:auto}
  .uni{border:1px solid #eef2f5;border-radius:14px;padding:10px 12px;margin:8px 0}
  .rank{display:inline-block;padding:2px 8px;border-radius:8px;font-weight:800;color:#fff;margin-bottom:4px}
  .rank.t1{background:#23B899} .rank.t2{background:#FDE200;color:#222} .rank.t3{background:#F66E6E}
  .uni-name{font-weight:700;color:var(--ink)}
  .panel-toggle{
    position:absolute; top:12px; right:12px; background:#fff; border:1px solid #e5e9ee;
    border-radius:10px; padding:8px 12px; font-size:14px; cursor:pointer;
  }

  /* Floating panel on desktop */
  @media (min-width:901px){
    .panel{
      position:absolute; top:20px; right:20px; bottom:20px; width:420px;
      border-radius:20px; padding:20px; border-left:none;
      box-shadow:0 12px 30px rgba(0,0,0,.12); overflow:hidden; z-index:10;
    }
    .panel-head{padding:14px 20px;}
    .list{padding:12px 20px 20px;}
  }

  @media (max-width:900px){
    .app{grid-template-columns:1fr;grid-template-rows:55vh 1fr}
    .app.closed{grid-template-rows:1fr}
    .panel{border-left:none;border-top:1px solid #e9eef2}
  }
</style>
</head>
<body>
<div class="app closed">
  <div class="map-wrap">
    <button id="togglePanel" class="panel-toggle" aria-expanded="false" title="Open universities panel">Open panel ▸</button>
    <svg id="map" aria-label="Europe map"></svg>
  </div>

  <aside class="panel">
    <div class="panel-head">
      <div style="display:flex;gap:10px;align-items:center">
        <div class="panel-title" id="panelTitle">Pick a country</div>
        <div class="panel-count" id="panelCount">0 universities</div>
      </div>
      <button id="closePanelBtn" style="background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:6px 10px;cursor:pointer">Close ✕</button>
    </div>

    <div style="padding:10px 20px;border-bottom:1px solid #e9eef2">
      <input id="countrySearch" type="text" placeholder="Search country…" 
             style="width:100%;padding:10px 12px;border:1px solid #e5e9ee;border-radius:10px;font-size:14px;margin-bottom:8px"/>
      <input id="uniSearch" type="text" placeholder="Search university…" 
             style="width:100%;padding:10px 12px;border:1px solid #e5e9ee;border-radius:10px;font-size:14px"/>
    </div>

    <div class="list" id="uniList"></div>
  </aside>
</div>

<script>
// ===== Config: initial zoom like browser 67% =====
const INITIAL_K = 0.67;

const QS = [
  {country:'Switzerland', euRank:1, name:'ETH Zurich - Swiss Federal Institute of Technology'},
  {country:'United Kingdom', euRank:2, name:'Imperial College London'},
  {country:'United Kingdom', euRank:3, name:'University of Oxford'},
  {country:'United Kingdom', euRank:4, name:'University of Cambridge'},
  {country:'United Kingdom', euRank:5, name:'UCL'},
  {country:'United Kingdom', euRank:6, name:'The University of Edinburgh'},
  {country:'United Kingdom', euRank:7, name:'The University of Manchester'},
  {country:'United Kingdom', euRank:8, name:'King\'s College London'},
  {country:'France', euRank:9, name:'Université PSL'},
  {country:'Switzerland', euRank:10, name:'EPFL'},
  {country:'Germany', euRank:11, name:'Technical University of Munich'},
  {country:'United Kingdom', euRank:12, name:'The London School of Economics and Political Science (LSE)'},
  {country:'Sweden', euRank:13, name:'Lund University'},
  {country:'United Kingdom', euRank:14, name:'University of Bristol'},
  {country:'Netherlands', euRank:15, name:'Delft University of Technology'},
  {country:'United Kingdom', euRank:16, name:'University of Glasgow'},
  {country:'Netherlands', euRank:17, name:'University of Amsterdam'},
  {country:'United Kingdom', euRank:20, name:'University of Leeds'},
  {country:'Germany', euRank:21, name:'Ludwig-Maximilians-Universität München'},
  {country:'United Kingdom', euRank:22, name:'The University of Warwick'},
  {country:'France', euRank:23, name:'Institut Polytechnique de Paris'},
  {country:'United Kingdom', euRank:24, name:'University of Nottingham'},
  {country:'Sweden', euRank:25, name:'Uppsala University'},
  {country:'Ireland', euRank:26, name:'Trinity College Dublin, The University of Dublin'},
  {country:'United Kingdom', euRank:29, name:'The University of Sheffield'},
  {country:'France', euRank:30, name:'Université Paris-Saclay'},
  {country:'France', euRank:31, name:'Sorbonne University'},
  {country:'United Kingdom', euRank:32, name:'Durham University'},
  {country:'Denmark', euRank:33, name:'University of Copenhagen'},
  {country:'United Kingdom', euRank:34, name:'University of Southampton'},
  {country:'United Kingdom', euRank:35, name:'Newcastle University'},
  {country:'Switzerland', euRank:36, name:'University of Zurich'},
  {country:'United Kingdom', euRank:37, name:'University of St Andrews'},
  {country:'Netherlands', euRank:40, name:'Utrecht University'},
  {country:'Finland', euRank:41, name:'Aalto University'},
  {country:'Austria', euRank:42, name:'University of Vienna'},
  {country:'Germany', euRank:43, name:'Freie Universitaet Berlin'},
  {country:'Finland', euRank:46, name:'University of Helsinki'},
  {country:'Belgium', euRank:47, name:'Ghent University'},
  {country:'Italy', euRank:48, name:'Alma Mater Studiorum - University of Bologna'},
  {country:'Ireland', euRank:51, name:'University College Dublin'},
  {country:'Netherlands', euRank:52, name:'Leiden University'},
  {country:'Germany', euRank:58, name:'RWTH Aachen University'},
  {country:'Germany', euRank:59, name:'KIT, Karlsruhe Institute of Technology'},
  {country:'United Kingdom', euRank:60, name:'Cardiff University'},
  {country:'Spain', euRank:61, name:'Complutense University of Madrid'},
  {country:'United Kingdom', euRank:62, name:'University of Bath'},
  {country:'United Kingdom', euRank:63, name:'Lancaster University'},
  {country:'Norway', euRank:64, name:'University of Oslo'},
  {country:'Netherlands', euRank:65, name:'Erasmus University Rotterdam '},
  {country:'Germany', euRank:68, name:'Humboldt-Universität zu Berlin'},
  {country:'Denmark', euRank:69, name:'Technical University of Denmark'},
  {country:'United Kingdom', euRank:70, name:'University of York'},
  {country:'Sweden', euRank:71, name:'University of Gothenburg'},
  {country:'Spain', euRank:72, name:'Universidad Autónoma de Madrid'},
  {country:'Belgium', euRank:75, name:'Université catholique de Louvain (UCLouvain)'},
  {country:'Germany', euRank:76, name:'Albert-Ludwigs-Universitaet Freiburg'},
  {country:'Germany', euRank:77, name:'Rheinische Friedrich-Wilhelms-Universität Bonn'},
  {country:'Sweden', euRank:78, name:'Chalmers University of Technology'},
  {country:'Czech Republic', euRank:79, name:'Charles University'},
  {country:'Switzerland', euRank:80, name:'University of Basel'},
  {country:'Germany', euRank:81, name:'Universität Hamburg'},
  {country:'Germany', euRank:82, name:'University of Göttingen'},
  {country:'Netherlands', euRank:83, name:'Vrije Universiteit Amsterdam'},
  {country:'Italy', euRank:87, name:'Università di Padova'},
  {country:'Netherlands', euRank:88, name:'Eindhoven University of Technology'},
  {country:'Netherlands', euRank:89, name:'Maastricht University '},
  {country:'United Kingdom', euRank:90, name:'University of Aberdeen'},
  {country:'Spain', euRank:91, name:'University of Navarra'},
  {country:'Portugal', euRank:92, name:'University of Lisbon '},
  {country:'Germany', euRank:93, name:'Technische Universität Dresden'},
  {country:'Belgium', euRank:94, name:'Universite libre de Bruxelles'},
  {country:'Norway', euRank:95, name:'Norwegian University of Science And Technology'},
  {country:'Poland', euRank:96, name:'University of Warsaw '},
  {country:'United Kingdom', euRank:97, name:'Swansea University'},
  {country:'Germany', euRank:100, name:'University of Cologne'},
  {country:'Switzerland', euRank:101, name:'University of Lausanne'},
  {country:'Spain', euRank:102, name:'Universitat Pompeu Fabra (Barcelona)'},
  {country:'Sweden', euRank:107, name:'Linköping University'},
  {country:'United Kingdom', euRank:108, name:'University of Sussex'},
  {country:'United Kingdom', euRank:112, name:'University of Strathclyde'},
  {country:'Italy', euRank:113, name:'University of Milan'},
  {country:'Germany', euRank:116, name:'Westfälische Wilhelms-Universität Münster '},
  {country:'Spain', euRank:117, name:'Universidad Politécnica de Madrid (UPM)'},
  {country:'Netherlands', euRank:118, name:'University of Twente'},
  {country:'Spain', euRank:119, name:'Universidad Carlos III de Madrid (UC3M)'},
  {country:'Germany', euRank:122, name:'Friedrich-Alexander-Universität Erlangen-Nürnberg'},
  {country:'Turkey', euRank:123, name:'Istanbul Technical University'},
  {country:'United Kingdom', euRank:124, name:'University of Surrey'},
  {country:'France', euRank:125, name:'Université Grenoble Alpes'},
  {country:'United Kingdom', euRank:126, name:'University of Leicester'},
  {country:'United Kingdom', euRank:127, name:'Heriot-Watt University'},
  {country:'Spain', euRank:128, name:'Universitat Politècnica de Catalunya · BarcelonaTech (UPC)'},
  {country:'United Kingdom', euRank:129, name:'City, University of London'},
  {country:'Denmark', euRank:130, name:'University of Southern Denmark (SDU)'},
  {country:'Denmark', euRank:131, name:'Aalborg University'},
  {country:'France', euRank:132, name:'Ecole des Ponts ParisTech'},
  {country:'Portugal', euRank:133, name:'Universidade Nova de Lisboa'},
  {country:'Germany', euRank:134, name:'Technical University of Darmstadt'},
  {country:'Finland', euRank:135, name:'University of Turku'},
  {country:'France', euRank:142, name:'École Normale Supérieure de Lyon'},
  {country:'Czech Republic', euRank:143, name:'Masaryk University'},
  {country:'Austria', euRank:144, name:'Universität Innsbruck'},
  {country:'Ireland', euRank:145, name:'University of Limerick'},
  {country:'Greece', euRank:148, name:'National and Kapodistrian University of Athens'},
  {country:'United Kingdom', euRank:149, name:'University of East Anglia (UEA)'},
  {country:'Germany', euRank:150, name:'Universität Stuttgart'},
  {country:'Italy', euRank:151, name:'University of Naples - Federico II'},
  {country:'United Kingdom', euRank:156, name:'Brunel University London'},
  {country:'Turkey', euRank:159, name:'Koç University'},
  {country:'Spain', euRank:160, name:'University of Granada'},
  {country:'France', euRank:163, name:'Université de Strasbourg'},
  {country:'France', euRank:164, name:'Aix-Marseille University'},
  {country:'United Kingdom', euRank:171, name:'University of Kent'},
  {country:'Germany', euRank:172, name:'Leibniz University Hannover'},
  {country:'Spain', euRank:173, name:'Universitat Ramon Llull'},
  {country:'Finland', euRank:174, name:'Tampere University'},
  {country:'Spain', euRank:175, name:'Universitat Politècnica de València'},
  {country:'Germany', euRank:176, name:'Universität Konstanz'},
  {country:'Czech Republic', euRank:177, name:'Czech Technical University in Prague'},
  {country:'Greece', euRank:180, name:'National Technical University of Athens'},
  {country:'Luxembourg', euRank:181, name:'University of Luxembourg'},
  {country:'France', euRank:182, name:'University of Bordeaux'},
  {country:'Spain', euRank:183, name:'University of Salamanca'},
  {country:'Turkey', euRank:184, name:'Bilkent University'},
  {country:'Sweden', euRank:185, name:'Umea University'},
  {country:'Turkey', euRank:188, name:'Sabanci University'},
  {country:'United Kingdom', euRank:189, name:'Nottingham Trent University'},
  {country:'Spain', euRank:192, name:'University of the Basque Country'},
  {country:'Germany', euRank:193, name:'Universität Potsdam'},
  {country:'United Kingdom', euRank:194, name:'Manchester Metropolitan University (MMU)'},
  {country:'United Kingdom', euRank:195, name:'University of Stirling'},
  {country:'Germany', euRank:200, name:'Universität Leipzig'},
  {country:'Germany', euRank:203, name:'University of Bayreuth'},
  {country:'Germany', euRank:204, name:'Christian-Albrechts-University zu Kiel'},
  {country:'Poland', euRank:208, name:'Warsaw University of Technology'},
  {country:'United Kingdom', euRank:213, name:'Northumbria University at Newcastle'},
  {country:'Germany', euRank:217, name:'Julius-Maximilians-Universität Würzburg'},
  {country:'Slovenia', euRank:221, name:'University of Ljubljana'},
  {country:'United Kingdom', euRank:230, name:'University of Huddersfield'},
  {country:'France', euRank:233, name:'Université Paul Sabatier Toulouse III'},
  {country:'United Kingdom', euRank:236, name:'Birkbeck, University of London'},
  {country:'United Kingdom', euRank:239, name:'University of Portsmouth'},
  {country:'Austria', euRank:242, name:'Karl-Franzens-Universitaet Graz'},
  {country:'Croatia', euRank:243, name:'University of Zagreb'},
  {country:'United Kingdom', euRank:244, name:'University of the West of England'},
  {country:'Switzerland', euRank:245, name:'USI - Università della Svizzera italiana'},
  {country:'Cyprus', euRank:246, name:'University of Cyprus (UCY)'},
  {country:'Hungary', euRank:247, name:'Budapest University of Technology and Economics'},
  {country:'Portugal', euRank:248, name:'University of Minho'},
  {country:'Czech Republic', euRank:253, name:'Czech University of Life Sciences in Prague'},
  {country:'Estonia', euRank:254, name:'Tallinn University of Technology (TalTech)'},
  {country:'Germany', euRank:255, name:'Martin-Luther-Universität Halle-Wittenberg'},
  {country:'United Kingdom', euRank:262, name:'University of Greenwich'},
  {country:'United Kingdom', euRank:263, name:'Liverpool John Moores University'},
  {country:'Turkey', euRank:264, name:'Ankara Üniversitesi'},
  {country:'Ukraine', euRank:265, name:'Taras Shevchenko National University of Kyiv'},
  {country:'Portugal', euRank:266, name:'Universidade Católica Portuguesa - UCP'},
  {country:'United Kingdom', euRank:271, name:'Aberystwyth University'},
  {country:'Norway', euRank:274, name:'University of Tromsø The Arctic University of Norway'},
  {country:'France', euRank:275, name:'Université de Lorraine'},
  {country:'France', euRank:276, name:'Université Côte d\\\'Azur'},
  {country:'Germany', euRank:284, name:'Universität Regensburg'},
  {country:'United Kingdom', euRank:285, name:'Middlesex University'},
  {country:'Spain', euRank:288, name:'Universidad de Valladolid'},
  {country:'Poland', euRank:302, name:'Gdańsk University of Technology'},
  {country:'Greece', euRank:303, name:'University of Patras'},
  {country:'Austria', euRank:309, name:'University of Klagenfurt'},
  {country:'France', euRank:310, name:'Université de Nantes'},
  {country:'Italy', euRank:311, name:'University of Bari'},
  {country:'Spain', euRank:312, name:'University of Deusto'},
  {country:'United Kingdom', euRank:313, name:'University of Brighton'},
  {country:'Hungary', euRank:314, name:'University of Pecs'},
  {country:'Italy', euRank:315, name:'University of Salerno'},
  {country:'Lithuania', euRank:316, name:'Vilnius Gediminas Technical University'},
  {country:'Ukraine', euRank:319, name:'V. N. Karazin Kharkiv National University'},
  {country:'Italy', euRank:320, name:'University of Messina (UniME)'},
  {country:'Cyprus', euRank:321, name:'University of Nicosia'},
  {country:'Italy', euRank:322, name:'Free University of Bozen-Bolzano'},
  {country:'Portugal', euRank:330, name:'ISCTE - Instituto Universitario de Lisboa'},
  {country:'United Kingdom', euRank:331, name:'University of Lincoln'},
  {country:'Azerbaijan', euRank:336, name:'Baku State University'},
  {country:'Italy', euRank:337, name:'University of Palermo'},
  {country:'Spain', euRank:340, name:'Universidad de Córdoba - España'},
  {country:'Italy', euRank:347, name:'University of Calabria'},
  {country:'United Kingdom', euRank:352, name:'Robert Gordon University'},
  {country:'Norway', euRank:353, name:'University of Stavanger'},
  {country:'Italy', euRank:354, name:'University of Brescia'},
  {country:'Italy', euRank:357, name:'Catania University'},
  {country:'Italy', euRank:358, name:'Università degli Studi di Perugia'},
  {country:'Spain', euRank:359, name:'Universidad Rey Juan Carlos'},
  {country:'United Kingdom', euRank:362, name:'Queen Margaret University , Edinburgh'},
  {country:'Turkey', euRank:363, name:'EGE UNIVERSITY'},
  {country:'Netherlands', euRank:364, name:'NHTV Breda University of Applied Sciences'},
  {country:'Spain', euRank:367, name:'Universidad de León'},
  {country:'Belgium', euRank:368, name:'University of Mons '},
  {country:'Italy', euRank:369, name:'University of Parma'},
  {country:'Spain', euRank:374, name:'Universitat Internacional de Catalunya (UIC)'},
  {country:'Italy', euRank:375, name:'Politecnico di Bari'},
  {country:'United Kingdom', euRank:376, name:'University of Wolverhampton'},
  {country:'Latvia', euRank:377, name:'Riga Stradins University'},
  {country:'United Kingdom', euRank:378, name:'University of Hertfordshire'},
  {country:'Cyprus', euRank:383, name:'Cyprus University of Technology'},
  {country:'Italy', euRank:386, name:'Universita\' degli Studi di Ferrara'},
  {country:'Slovakia', euRank:387, name:'Slovak University of Technology in Bratislava'},
  {country:'France', euRank:388, name:'University Paris 2 Panthéon-Assas'},
  {country:'Estonia', euRank:393, name:'Tallinn University '},
  {country:'Romania', euRank:402, name:'Alexandru Ioan Cuza University'},
  {country:'Georgia', euRank:406, name:'Ivane Javakhishvili Tbilisi State University'},
  {country:'Portugal', euRank:407, name:'University of the Algarve'},
  {country:'Slovakia', euRank:408, name:'Pavol Jozef Šafárik University in Košice'},
  {country:'Turkey', euRank:411, name:'Istanbul Gelisim University'},
  {country:'Denmark', euRank:415, name:'Roskilde University'},
  {country:'United Kingdom', euRank:418, name:'Birmingham City University '},
  {country:'United Kingdom', euRank:431, name:'London Metropolitan University'},
  {country:'Slovakia', euRank:432, name:'Technical University of Kosice'},
  {country:'Romania', euRank:435, name:'Universitatea de Vest din Timisoara / West University of Timisoara'},
  {country:'France', euRank:436, name:'Université Paris-Nanterre'},
  {country:'N. Macedonia', euRank:440, name:'Ss. Cyril and Methodius University of Skopje'},
  {country:'Ukraine', euRank:441, name:'Interregional Academy of Personnel Management'},
  {country:'United Kingdom', euRank:442, name:'University of Sunderland'},
  {country:'Sweden', euRank:448, name:'University College of Boras'},
  {country:'France', euRank:449, name:'Université Polytechnique Hauts-de-France'},
  {country:'Poland', euRank:452, name:'Wrocław University of Environmental and Life Sciences'},
  {country:'Turkey', euRank:457, name:'Cankaya Üniversitesi'},
  {country:'Italy', euRank:465, name:'Universitö degli Studi dell\'Insubria'},
  {country:'Italy', euRank:477, name:'Universita\' degli studi di Foggia'},
  {country:'Switzerland', euRank:478, name:'University of Applied Sciences of Southern Switzerland'},
  {country:'Netherlands', euRank:482, name:'Zuyd University (Zuyd University of Applied Sciences)'},
  {country:'France', euRank:493, name:'Université Jean Monnet, Saint-Etienne'},
];
const byCountry = c => QS.filter(d=>d.country===c).sort((a,b)=>a.euRank-b.euRank);
const tier = r => r<=50?'t1':(r<=200?'t2':'t3');

// -------- Map scaffolding --------
const svg = d3.select('#map');
const gRest      = svg.append('g');
const gCountries = svg.append('g');
const gLabels    = svg.append('g');

let projection, path, LABELS = [];
let selectedCountry = null, INTERACTIVE = [];

const EUROPE = new Set(["Albania","Andorra","Armenia","Azerbaijan","Austria","Belarus","Belgium","Bosnia and Herz.","Bulgaria","Canada","Croatia","Czechia","Denmark","Estonia","Finland","France","Germany","Greece","Hungary","Iceland","Ireland","Italy","Kosovo","Latvia","Liechtenstein","Lithuania","Luxembourg","Malta","Moldova","Monaco","Montenegro","Netherlands","North Macedonia","Norway","Poland","Portugal","Romania","San Marino","Serbia","Slovakia","Slovenia","Spain","Sweden","Switzerland","Ukraine","United Kingdom","Vatican","Georgia","Turkey","Russia","Mexico","United States of America"]);
const NAME_FIX = new Map([["Bosnia and Herz.","Bosnia & Herzegovina"],["Czechia","Czech Republic"],["North Macedonia","N. Macedonia"]]);
const HIDE_LABELS = new Set(["Vatican","Kosovo","Andorra","San Marino","Monaco","Luxembourg","Albania"]);

const measure = (()=>{const c=document.createElement('canvas');const ctx=c.getContext('2d');return (t,px)=>{ctx.font=`700 ${px}px ui-sans-serif, system-ui, Arial`;return ctx.measureText(t).width;};})();

function reassignCrimea(features){
  const uk=features.find(f=>rawName(f)==='Ukraine'); const ru=features.find(f=>rawName(f)==='Russia');
  if(!uk||!ru||ru.geometry.type!=='MultiPolygon') return;
  const inCrimea=poly=>{const c=d3.geoCentroid({type:'Polygon',coordinates:poly});const[lon,lat]=c;return(lon>=32&&lon<=37.5&&lat>=44&&lat<=46.8);};
  const keep=[],move=[]; for(const poly of ru.geometry.coordinates){(inCrimea(poly)?move:keep).push(poly);}
  if(move.length===0) return; ru.geometry.coordinates=keep;
  if(uk.geometry.type==='Polygon'){uk.geometry={type:'MultiPolygon',coordinates:[uk.geometry.coordinates]};}
  uk.geometry.coordinates.push(...move);
}

// Zoom: allow zooming out to INITIAL_K, up to 9x in
const zoom = d3.zoom().scaleExtent([INITIAL_K, 9]).on('zoom', ev => {
  const t = ev.transform, k = t.k;
  gRest.attr('transform', t);
  gCountries.attr('transform', t);
  updateLabels(k, t);
});
svg.call(zoom);

function render(){
  const w = svg.node().clientWidth, h = svg.node().clientHeight;
  projection = d3.geoMercator().center([15,53]).scale(Math.min(w,h)*0.85).translate([w/2,h/2]);
  path = d3.geoPath(projection);

  d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json").then(topology=>{
    const world = topojson.feature(topology, topology.objects.countries);
    const bounds = path.bounds(world);
    zoom.extent([[0,0],[w,h]]).translateExtent(bounds);
    svg.call(zoom);

    const rest = world.features.filter(f => !EUROPE.has(rawName(f)));
    gRest.selectAll('path.rest').data(rest,d=>rawName(d)).join('path').attr('class','rest').attr('d', path);

    const features = world.features.filter(f => EUROPE.has(rawName(f)));
    INTERACTIVE = features;
    reassignCrimea(features);

    gCountries.selectAll('path.country').data(features,d=>rawName(d)).join('path')
      .attr('class','country').attr('d', path)
      .on('click', (e,d)=>{ selectedCountry = displayName(d); showCountry(selectedCountry); updateCountryFills(); openPanel(); })
      .on('mouseenter', function(e,d){ if(displayName(d)!==selectedCountry) d3.select(this).attr('fill','var(--hover)'); })
      .on('mouseleave', function(e,d){ d3.select(this).attr('fill', displayName(d)===selectedCountry ? 'var(--hover)' : 'var(--land)'); })
      .attr('fill','var(--land)').attr('stroke','var(--border)');

    LABELS = features.map(f=>{
      const name = displayName(f); if(HIDE_LABELS.has(name)) return null;
      const g = f.geometry; let ll;
      try{
        if(g.type==="Polygon") ll = polylabel(g.coordinates,1.0);
        else if(g.type==="MultiPolygon"){ let best=null,bestA=-Infinity; for(const p of g.coordinates){ const cand=polylabel(p,1.0); const A=ringArea(p[0]); if(A>bestA){bestA=A; best=cand;}} ll=best; }
      }catch(_){ ll = d3.geoCentroid(f); }
      let [x,y] = projection(ll); if(name==='France'){ x += 80; y -= 56; }
      return {name, feature:f, x, y};
    }).filter(Boolean);

    gLabels.selectAll('text.label').data(LABELS,d=>d.name).join('text').attr('class','label').text(d=>d.name);

    // Initial layout, then apply initial zoom to ~67%
    updateLabels(1, d3.zoomIdentity);
    updateCountryFills();
    svg.call(zoom.scaleTo, INITIAL_K); // <-- start zoomed out
  });
}

function updateCountryFills(){
  gCountries.selectAll('path.country')
    .classed('selected', d => displayName(d)===selectedCountry)
    .attr('fill', d => displayName(d)===selectedCountry ? 'var(--hover)' : 'var(--land)');
}

function rawName(f){ return (f.properties && (f.properties.name || f.id)) || 'Unknown'; }
function displayName(f){ const n = rawName(f); return NAME_FIX.get(n) || n; }
function ringArea(ring){ let a=0; for(let i=0,j=ring.length-1;i<ring.length;j=i++){const [x1,y1]=ring[j],[x2,y2]=ring[i]; a+=(x1*y2-x2*y1);} return Math.abs(a/2); }

function updateLabels(k, t){
  const basePx = 9, px = Math.max(10, basePx / k), halo = Math.max(1, 3 / k);
  const sel = gLabels.selectAll('text.label')
    .style('font-size', `${px}px`).style('stroke-width', `${halo}px`)
    .attr('x', d => t.applyX(d.x)).attr('y', d => t.applyY(d.y)).attr('display', null);
  const placed = [];
  sel.each(function(d){
    const el = this, text = d.name, w = measure(text, px), h = px,
          x = +el.getAttribute('x') - w/2, y = +el.getAttribute('y') - h/2;
    const overlap = placed.some(p => !(x+w < p.x || p.x+p.w < x || y+h < p.y || p.y+p.h < y));
    if(overlap){ el.setAttribute('display','none'); return; }
    placed.push({x,y,w,h});
  });
}

// -------- Right panel --------
function showCountry(country){
  const list = byCountry(country);
  document.getElementById('panelTitle').textContent = country;
  document.getElementById('panelCount').textContent = `${list.length} ${list.length===1?'university':'universities'}`;
  document.getElementById('uniList').innerHTML = list.length ? list.map(u=>`
    <div class="uni">
      <span class="rank ${tier(u.euRank)}">#${u.euRank} in Europe</span>
      <div class="uni-name">${u.name}</div>
    </div>
  `).join('') : `<div class="muted">No universities listed yet.</div>`;
}

// ---- Search ----
const searchEl = document.getElementById('countrySearch');
searchEl.addEventListener('keydown', e=>{
  if(e.key!=='Enter') return;
  const q = e.target.value.trim().toLowerCase(); if(!q) return;
  const names = INTERACTIVE.map(d => displayName(d));
  let pick = names.find(n=>n.toLowerCase()===q) || names.find(n=>n.toLowerCase().startsWith(q)) || names.find(n=>n.toLowerCase().includes(q));
  if(pick){ selectedCountry=pick; showCountry(pick); updateCountryFills(); openPanel(); }
});

const uniSearchEl = document.getElementById('uniSearch');
uniSearchEl.addEventListener('keydown', e=>{
  if(e.key!=='Enter') return;
  const q = e.target.value.trim().toLowerCase(); if(!q) return;
  let match = QS.find(u=>u.name.toLowerCase()===q) || QS.find(u=>u.name.toLowerCase().startsWith(q)) || QS.find(u=>u.name.toLowerCase().includes(q));
  if(match){
    selectedCountry = match.country; showCountry(match.country); updateCountryFills(); openPanel();
    requestAnimationFrame(()=>{
      const cards = document.querySelectorAll('#uniList .uni');
      for(const card of cards){
        const nameEl = card.querySelector('.uni-name');
        if(nameEl && nameEl.textContent.trim().toLowerCase() === match.name.toLowerCase()){
          card.scrollIntoView({behavior:'smooth', block:'center'});
          const original = card.style.backgroundColor;
          card.style.transition = 'background-color .6s ease';
          card.style.backgroundColor = '#FFF3C4';
          setTimeout(()=>{ card.style.backgroundColor = original || ''; }, 1200);
          break;
        }
      }
    });
  }
});

// ---- Panel open/close control ----
const appEl = document.querySelector('.app');
const toggleBtn = document.getElementById('togglePanel');
const closeBtn = document.getElementById('closePanelBtn');
function openPanel(){ appEl.classList.remove('closed'); toggleBtn.setAttribute('aria-expanded','true'); toggleBtn.style.display='none'; }
function closePanel(){ appEl.classList.add('closed'); toggleBtn.setAttribute('aria-expanded','false'); toggleBtn.style.display='block'; }
toggleBtn.addEventListener('click', openPanel);
closeBtn.addEventListener('click', closePanel);

window.addEventListener('resize', render);
render();
showCountry('United Kingdom'); // optional default
closePanel(); // start map-only
</script>
</body>
</html>
