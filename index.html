<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Levels Academy – Europe (Clickable Countries)</title>

<!-- D3 + TopoJSON + polylabel (for placing labels inside borders) -->
<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://unpkg.com/@mapbox/polylabel@1.1.0/polylabel.min.js"></script>

<style>
  :root{
    --sea:#7ecbff;      /* light blue water */
    --land:#ffffff;     /* white countries */
    --border:#cfd6dc;   /* subtle borders */
    --hover:#23B89922;  /* faint hover */
    --brand:#2B445B; --ink:#0f1f29; --muted:#6b7a86;
    --t1:#23B899; --t2:#FDE200; --t3:#F66E6E;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,Arial}
  .app{display:grid;grid-template-columns:1.5fr .9fr;height:100vh}
  .map-wrap{background:var(--sea);position:relative}
  svg{width:100%;height:100%}
  .country{fill:var(--land);stroke:var(--border);stroke-width:1;cursor:pointer;transition:fill .12s ease}
  .country:hover{fill:var(--hover)}
  .label{fill:#000; font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.3px; pointer-events:none; }
  .panel{background:#fff;border-left:1px solid #e9eef2;display:flex;flex-direction:column}
  .panel-head{background:var(--brand);color:#fff;padding:14px 16px;display:flex;justify-content:space-between;align-items:center}
  .panel-title{font-weight:800}
  .panel-count{opacity:.9}
  .list{padding:12px;overflow:auto}
  .uni{border:1px solid #eef2f5;border-radius:14px;padding:10px 12px;margin:8px 0}
  .rank{display:inline-block;padding:2px 8px;border-radius:8px;font-weight:800;color:#fff;margin-bottom:4px}
  .rank.t1{background:var(--t1)} .rank.t2{background:var(--t2);color:#222} .rank.t3{background:var(--t3)}
  .uni-name{font-weight:700;color:var(--ink)} .muted{color:var(--muted);font-size:12px}
  @media (max-width:900px){ .app{grid-template-columns:1fr;grid-template-rows:55vh 1fr} .panel{border-left:none;border-top:1px solid #e9eef2} }
</style>
</head>
<body>
<div class="app">
  <div class="map-wrap">
    <svg id="map" aria-label="Europe map"></svg>
  </div>

  <aside class="panel">
    <div class="panel-head">
      <div class="panel-title" id="panelTitle">Pick a country</div>
      <div class="panel-count" id="panelCount">0 universities</div>
    </div>
    <div class="list" id="uniList"></div>
  </aside>
</div>

<script>
// ===== DEMO DATA (replace with QS extract later) =====
const QS = [
  {country:'United Kingdom', euRank:2,  name:'Imperial College London'},
  {country:'United Kingdom', euRank:3,  name:'University of Oxford'},
  {country:'United Kingdom', euRank:4,  name:'University of Cambridge'},
  {country:'United Kingdom', euRank:5,  name:'UCL (University College London)'},
  {country:'United Kingdom', euRank:8,  name:"King's College London"},
  {country:'United Kingdom', euRank:12, name:'LSE – London School of Economics'},
  {country:'Switzerland',    euRank:1,  name:'ETH Zurich'},
  {country:'Switzerland',    euRank:10, name:'EPFL'},
  {country:'Germany',        euRank:11, name:'Technical University of Munich (TUM)'},
  {country:'Germany',        euRank:18, name:'LMU Munich'},
  {country:'France',         euRank:9,  name:'Université PSL'},
  {country:'Netherlands',    euRank:15, name:'Delft University of Technology'},
  {country:'Netherlands',    euRank:17, name:'University of Amsterdam'},
  {country:'Sweden',         euRank:13, name:'Lund University'},
];
const tier = r => r<=50?'t1':(r<=200?'t2':'t3');
const byCountry = c => QS.filter(d=>d.country===c).sort((a,b)=>a.euRank-b.euRank);

// ===== MAP =====
const svg = d3.select('#map');
const gCountries = svg.append('g'); // countries
const gLabels    = svg.append('g'); // country names (we cull overlaps on zoom)

let projection, path;

// Europe-only allowlist (to avoid Syria etc.)
const EUROPE_LIST = new Set([
  "Albania","Andorra","Austria","Belarus","Belgium","Bosnia and Herz.","Bulgaria","Croatia","Czechia",
  "Denmark","Estonia","Finland","France","Germany","Greece","Hungary","Iceland","Ireland","Italy",
  "Kosovo","Latvia","Liechtenstein","Lithuania","Luxembourg","Malta","Moldova","Monaco","Montenegro",
  "Netherlands","North Macedonia","Norway","Poland","Portugal","Romania","San Marino","Serbia",
  "Slovakia","Slovenia","Spain","Sweden","Switzerland","Ukraine","United Kingdom","Vatican","Georgia","Turkey"
]);

// zoom & pan
const zoom = d3.zoom().scaleExtent([1, 8]).on('zoom', (ev)=>{
  const {transform} = ev;
  gCountries.attr('transform', transform);
  gLabels.attr('transform', transform);
  // Re-run label culling each zoom so names never overlap
  cullLabels();
});
svg.call(zoom);

function render(){
  const w = svg.node().clientWidth, h = svg.node().clientHeight;
  projection = d3.geoMercator().center([15,53]).scale(Math.min(w,h)*0.85).translate([w/2,h/2]);
  path = d3.geoPath(projection);

  d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json").then(topology=>{
    const world = topojson.feature(topology, topology.objects.countries);
    // Filter to Europe allowlist
    const europe = world.features.filter(f => EUROPE_LIST.has(nameOf(f)));

    // Draw countries
    gCountries.selectAll('path.country')
      .data(europe, d=>nameOf(d))
      .join('path')
      .attr('class','country')
      .attr('d', path)
      .on('click', (e,d)=> showCountry(nameOf(d)))
      .on('mouseenter', function(){ d3.select(this).attr('fill','var(--hover)'); })
      .on('mouseleave', function(){ d3.select(this).attr('fill','var(--land)'); })
      .attr('fill','var(--land)')
      .attr('stroke','var(--border)');

    // Prepare label data: place inside polygon using polylabel; fallback to centroid
    const labelData = europe.map(f=>{
      const geom = f.geometry;
      let bestLL = null;
      try{
        if(geom.type === "Polygon"){
          bestLL = polylabel(geom.coordinates, 1.0); // returns [lon,lat]
        }else if(geom.type === "MultiPolygon"){
          // pick largest polygon for label
          let best = null, bestArea = -Infinity;
          for(const poly of geom.coordinates){
            const ll = polylabel(poly, 1.0);
            const a = ringArea(poly[0]); // rough area
            if(a > bestArea){ bestArea = a; best = ll; }
          }
          bestLL = best;
        }
      }catch(_){}
      if(!bestLL){ // fallback: geographic centroid
        bestLL = d3.geoCentroid(f);
      }
      const xy = projection(bestLL);
      return {name: nameOf(f), x: xy[0], y: xy[1], feature:f};
    });

    // Draw labels
    gLabels.selectAll('text.label')
      .data(labelData, d=>d.name)
      .join('text')
      .attr('class','label')
      .attr('x', d=>d.x)
      .attr('y', d=>d.y)
      .text(d=>d.name.toUpperCase());

    // Initial cull to avoid overlaps
    cullLabels();
  });
}

function nameOf(f){
  // world-atlas uses 'name' for display
  return (f.properties && (f.properties.name || f.id)) || 'Unknown';
}

// naive polygon ring area in lon/lat (just for picking the largest ring)
function ringArea(ring){
  let a=0; for(let i=0, j=ring.length-1; i<ring.length; j=i++){
    const [x1,y1]=ring[j], [x2,y2]=ring[i]; a += (x1*y2 - x2*y1);
  } return Math.abs(a/2);
}

// Hide labels that overlap or spill outside their country (fast bounding-box cull)
function cullLabels(){
  const labels = gLabels.selectAll('text.label');
  // reset visibility
  labels.attr('display', null);

  // 1) measure each label (approx) in screen space
  const nodes = [];
  labels.each(function(d){
    const el = this;
    const name = d.name.toUpperCase();
    // quick width estimate: characters * 7.2px (bold uppercase)
    const width = name.length * 7.2;
    const height = 12; // font-size
    const x = +el.getAttribute('x') - width/2;
    const y = +el.getAttribute('y') - height/2;
    nodes.push({el, d, x, y, width, height});
  });

  // 2) sort by country area (bigger countries get labels first)
  nodes.sort((a,b)=>{
    const ap = d3.geoArea(a.d.feature);
    const bp = d3.geoArea(b.d.feature);
    return bp - ap;
  });

  // 3) greedy collision removal
  const placed = [];
  for(const n of nodes){
    // check overlap
    const overlaps = placed.some(p => !(n.x+n.width < p.x || p.x+p.width < n.x || n.y+n.height < p.y || p.y+p.height < n.y));
    if(overlaps){ d3.select(n.el).attr('display','none'); continue; }

    // ensure label anchor point lies inside the country
    const ll = projection.invert([n.x + n.width/2, n.y + n.height/2]);
    if(!ll || !d3.geoContains(n.d.feature, ll)){ d3.select(n.el).attr('display','none'); continue; }

    placed.push(n);
  }
}

window.addEventListener('resize', render);
render();

// ===== RIGHT PANEL =====
const titleEl = document.getElementById('panelTitle');
const countEl  = document.getElementById('panelCount');
const listEl   = document.getElementById('uniList');

function showCountry(country){
  const list = byCountry(country);
  titleEl.textContent = country;
  countEl.textContent = `${list.length} ${list.length===1?'university':'universities'}`;
  listEl.innerHTML = list.length ? list.map(u=>`
    <div class="uni">
      <span class="rank ${tier(u.euRank)}">#${u.euRank}</span>
      <div class="uni-name">${u.name}</div>
      <div class="muted">Rank in Europe</div>
    </div>
  `).join('') : `<div class="muted">No universities listed yet.</div>`;
}
// Optional default
showCountry('United Kingdom');
</script>
</body>
</html>
