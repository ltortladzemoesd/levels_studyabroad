<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Levels Academy – Europe (Screen-constant Labels)</title>

<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://unpkg.com/@mapbox/polylabel@1.1.0/polylabel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@700&display=swap" rel="stylesheet"/>

<style>
  :root{
    --sea:#BBE0F9; --land:#ffffff; --border:#cfd6dc; --hover:#23B899;
    --brand:#2B445B; --ink:#0f1f29; --muted:#6b7a86;
    --t1:#23B899; --t2:#FDE200; --t3:#F66E6E;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,Arial}
  .app{display:grid;grid-template-columns:1.5fr .9fr;height:100vh; position:relative}
  .app.closed{grid-template-columns:1fr 0}
  .map-wrap{background:var(--sea); position:relative; grid-column:1 / -1;}
  svg{width:100%;height:100%}
  .country{fill:var(--land);stroke:var(--border);stroke-width:1;cursor:pointer;transition:fill .12s ease}
  .country:hover{fill:var(--hover)}
  .country.selected{fill:var(--hover) !important;}
  .label{ fill:#333333; font-family:'Red Hat Display', ui-sans-serif, system-ui, Arial; font-weight:700; letter-spacing:.3px; pointer-events:none; }
  .rest{fill:#F7FAFF; stroke:var(--border); stroke-width:1}
  .panel{background:#fff;border-left:1px solid #e9eef2;display:flex;flex-direction:column}
  .app.closed .panel{display:none}
  .panel-head{background:var(--brand);color:#fff;padding:14px 16px;display:flex;justify-content:space-between;align-items:center}
  .panel-title{font-weight:800}
  .panel-count{opacity:.9}
  .list{padding:12px;overflow:auto}
  .uni{border:1px solid #eef2f5;border-radius:14px;padding:10px 12px;margin:8px 0}
  .rank{display:inline-block;padding:2px 8px;border-radius:8px;font-weight:800;color:#fff;margin-bottom:4px}
  .rank.t1{background:#23B899} .rank.t2{background:#FDE200;color:#222} .rank.t3{background:#F66E6E}
  .uni-name{font-weight:700;color:var(--ink)}
  .panel-toggle{
    position:absolute; top:12px; right:12px; background:#fff; border:1px solid #e5e9ee;
    border-radius:10px; padding:8px 12px; font-size:14px; cursor:pointer;
  }

  /* Floating panel on desktop */
  @media (min-width:901px){
    .panel{
      position:absolute; top:20px; right:20px; bottom:20px; width:420px;
      border-radius:20px; padding:20px; border-left:none;
      box-shadow:0 12px 30px rgba(0,0,0,.12); overflow:hidden; z-index:10;
    }
    .panel-head{padding:14px 20px;}
    .list{padding:12px 20px 20px;}
  }

  @media (max-width:900px){
    .app{grid-template-columns:1fr;grid-template-rows:55vh 1fr}
    .app.closed{grid-template-rows:1fr}
    .panel{border-left:none;border-top:1px solid #e9eef2}
  }
</style>
</head>
<body>
<div class="app closed">
  <div class="map-wrap">
    <button id="togglePanel" class="panel-toggle" aria-expanded="false" title="Open universities panel">Open panel ▸</button>
    <svg id="map" aria-label="Europe map"></svg>
  </div>

  <aside class="panel">
    <div class="panel-head">
      <div style="display:flex;gap:10px;align-items:center">
        <div class="panel-title" id="panelTitle">Pick a country</div>
        <div class="panel-count" id="panelCount">0 universities</div>
      </div>
      <button id="closePanelBtn" style="background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:6px 10px;cursor:pointer">Close ✕</button>
    </div>

    <div style="padding:10px 20px;border-bottom:1px solid #e9eef2">
      <input id="countrySearch" type="text" placeholder="Search country…" 
             style="width:100%;padding:10px 12px;border:1px solid #e5e9ee;border-radius:10px;font-size:14px;margin-bottom:8px"/>
      <input id="uniSearch" type="text" placeholder="Search university…" 
             style="width:100%;padding:10px 12px;border:1px solid #e5e9ee;border-radius:10px;font-size:14px"/>
    </div>

    <div class="list" id="uniList"></div>
  </aside>
</div>

<script>
// ===== Config: initial zoom like browser 67% =====
const INITIAL_K = 0.67;

// -------- Demo QS data --------
const QS = [
  {country:'United Kingdom', euRank:2,  name:'Imperial College London'},
  {country:'United Kingdom', euRank:3,  name:'University of Oxford'},
  {country:'United Kingdom', euRank:4,  name:'University of Cambridge'},
  {country:'United Kingdom', euRank:5,  name:'UCL (University College London)'},
  {country:'United Kingdom', euRank:8,  name:"King's College London"},
  {country:'United Kingdom', euRank:12, name:'LSE – London School of Economics'},
  {country:'Switzerland',    euRank:1,  name:'ETH Zurich'},
  {country:'Switzerland',    euRank:10, name:'EPFL'},
  {country:'Germany',        euRank:11,  name:'Technical University of Munich (TUM)'},
  {country:'Germany',        euRank:18,  name:'LMU Munich'},
  {country:'France',         euRank:9,   name:'Université PSL'},
  {country:'Netherlands',    euRank:15,  name:'Delft University of Technology'},
  {country:'Netherlands',    euRank:17,  name:'University of Amsterdam'},
  {country:'Sweden',         euRank:13,  name:'Lund University'}
];
const byCountry = c => QS.filter(d=>d.country===c).sort((a,b)=>a.euRank-b.euRank);
const tier = r => r<=50?'t1':(r<=200?'t2':'t3');

// -------- Map scaffolding --------
const svg = d3.select('#map');
const gRest      = svg.append('g');
const gCountries = svg.append('g');
const gLabels    = svg.append('g');

let projection, path, LABELS = [];
let selectedCountry = null, INTERACTIVE = [];

const EUROPE = new Set(["Albania","Andorra","Armenia","Azerbaijan","Austria","Belarus","Belgium","Bosnia and Herz.","Bulgaria","Canada","Croatia","Czechia","Denmark","Estonia","Finland","France","Germany","Greece","Hungary","Iceland","Ireland","Italy","Kosovo","Latvia","Liechtenstein","Lithuania","Luxembourg","Malta","Moldova","Monaco","Montenegro","Netherlands","North Macedonia","Norway","Poland","Portugal","Romania","San Marino","Serbia","Slovakia","Slovenia","Spain","Sweden","Switzerland","Ukraine","United Kingdom","Vatican","Georgia","Turkey","Russia","Mexico","United States of America"]);
const NAME_FIX = new Map([["Bosnia and Herz.","Bosnia & Herzegovina"],["Czechia","Czech Republic"],["North Macedonia","N. Macedonia"]]);
const HIDE_LABELS = new Set(["Vatican","Kosovo","Andorra","San Marino","Monaco","Luxembourg","Albania"]);

const measure = (()=>{const c=document.createElement('canvas');const ctx=c.getContext('2d');return (t,px)=>{ctx.font=`700 ${px}px ui-sans-serif, system-ui, Arial`;return ctx.measureText(t).width;};})();

function reassignCrimea(features){
  const uk=features.find(f=>rawName(f)==='Ukraine'); const ru=features.find(f=>rawName(f)==='Russia');
  if(!uk||!ru||ru.geometry.type!=='MultiPolygon') return;
  const inCrimea=poly=>{const c=d3.geoCentroid({type:'Polygon',coordinates:poly});const[lon,lat]=c;return(lon>=32&&lon<=37.5&&lat>=44&&lat<=46.8);};
  const keep=[],move=[]; for(const poly of ru.geometry.coordinates){(inCrimea(poly)?move:keep).push(poly);}
  if(move.length===0) return; ru.geometry.coordinates=keep;
  if(uk.geometry.type==='Polygon'){uk.geometry={type:'MultiPolygon',coordinates:[uk.geometry.coordinates]};}
  uk.geometry.coordinates.push(...move);
}

// Zoom: allow zooming out to INITIAL_K, up to 9x in
const zoom = d3.zoom().scaleExtent([INITIAL_K, 9]).on('zoom', ev => {
  const t = ev.transform, k = t.k;
  gRest.attr('transform', t);
  gCountries.attr('transform', t);
  updateLabels(k, t);
});
svg.call(zoom);

function render(){
  const w = svg.node().clientWidth, h = svg.node().clientHeight;
  projection = d3.geoMercator().center([15,53]).scale(Math.min(w,h)*0.85).translate([w/2,h/2]);
  path = d3.geoPath(projection);

  d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json").then(topology=>{
    const world = topojson.feature(topology, topology.objects.countries);
    const bounds = path.bounds(world);
    zoom.extent([[0,0],[w,h]]).translateExtent(bounds);
    svg.call(zoom);

    const rest = world.features.filter(f => !EUROPE.has(rawName(f)));
    gRest.selectAll('path.rest').data(rest,d=>rawName(d)).join('path').attr('class','rest').attr('d', path);

    const features = world.features.filter(f => EUROPE.has(rawName(f)));
    INTERACTIVE = features;
    reassignCrimea(features);

    gCountries.selectAll('path.country').data(features,d=>rawName(d)).join('path')
      .attr('class','country').attr('d', path)
      .on('click', (e,d)=>{ selectedCountry = displayName(d); showCountry(selectedCountry); updateCountryFills(); openPanel(); })
      .on('mouseenter', function(e,d){ if(displayName(d)!==selectedCountry) d3.select(this).attr('fill','var(--hover)'); })
      .on('mouseleave', function(e,d){ d3.select(this).attr('fill', displayName(d)===selectedCountry ? 'var(--hover)' : 'var(--land)'); })
      .attr('fill','var(--land)').attr('stroke','var(--border)');

    LABELS = features.map(f=>{
      const name = displayName(f); if(HIDE_LABELS.has(name)) return null;
      const g = f.geometry; let ll;
      try{
        if(g.type==="Polygon") ll = polylabel(g.coordinates,1.0);
        else if(g.type==="MultiPolygon"){ let best=null,bestA=-Infinity; for(const p of g.coordinates){ const cand=polylabel(p,1.0); const A=ringArea(p[0]); if(A>bestA){bestA=A; best=cand;}} ll=best; }
      }catch(_){ ll = d3.geoCentroid(f); }
      let [x,y] = projection(ll); if(name==='France'){ x += 80; y -= 56; }
      return {name, feature:f, x, y};
    }).filter(Boolean);

    gLabels.selectAll('text.label').data(LABELS,d=>d.name).join('text').attr('class','label').text(d=>d.name);

    // Initial layout, then apply initial zoom to ~67%
    updateLabels(1, d3.zoomIdentity);
    updateCountryFills();
    svg.call(zoom.scaleTo, INITIAL_K); // <-- start zoomed out
  });
}

function updateCountryFills(){
  gCountries.selectAll('path.country')
    .classed('selected', d => displayName(d)===selectedCountry)
    .attr('fill', d => displayName(d)===selectedCountry ? 'var(--hover)' : 'var(--land)');
}

function rawName(f){ return (f.properties && (f.properties.name || f.id)) || 'Unknown'; }
function displayName(f){ const n = rawName(f); return NAME_FIX.get(n) || n; }
function ringArea(ring){ let a=0; for(let i=0,j=ring.length-1;i<ring.length;j=i++){const [x1,y1]=ring[j],[x2,y2]=ring[i]; a+=(x1*y2-x2*y1);} return Math.abs(a/2); }

function updateLabels(k, t){
  const basePx = 9, px = Math.max(10, basePx / k), halo = Math.max(1, 3 / k);
  const sel = gLabels.selectAll('text.label')
    .style('font-size', `${px}px`).style('stroke-width', `${halo}px`)
    .attr('x', d => t.applyX(d.x)).attr('y', d => t.applyY(d.y)).attr('display', null);
  const placed = [];
  sel.each(function(d){
    const el = this, text = d.name, w = measure(text, px), h = px,
          x = +el.getAttribute('x') - w/2, y = +el.getAttribute('y') - h/2;
    const overlap = placed.some(p => !(x+w < p.x || p.x+p.w < x || y+h < p.y || p.y+p.h < y));
    if(overlap){ el.setAttribute('display','none'); return; }
    placed.push({x,y,w,h});
  });
}

// -------- Right panel --------
function showCountry(country){
  const list = byCountry(country);
  document.getElementById('panelTitle').textContent = country;
  document.getElementById('panelCount').textContent = `${list.length} ${list.length===1?'university':'universities'}`;
  document.getElementById('uniList').innerHTML = list.length ? list.map(u=>`
    <div class="uni">
      <span class="rank ${tier(u.euRank)}">#${u.euRank} in Europe</span>
      <div class="uni-name">${u.name}</div>
    </div>
  `).join('') : `<div class="muted">No universities listed yet.</div>`;
}

// ---- Search ----
const searchEl = document.getElementById('countrySearch');
searchEl.addEventListener('keydown', e=>{
  if(e.key!=='Enter') return;
  const q = e.target.value.trim().toLowerCase(); if(!q) return;
  const names = INTERACTIVE.map(d => displayName(d));
  let pick = names.find(n=>n.toLowerCase()===q) || names.find(n=>n.toLowerCase().startsWith(q)) || names.find(n=>n.toLowerCase().includes(q));
  if(pick){ selectedCountry=pick; showCountry(pick); updateCountryFills(); openPanel(); }
});

const uniSearchEl = document.getElementById('uniSearch');
uniSearchEl.addEventListener('keydown', e=>{
  if(e.key!=='Enter') return;
  const q = e.target.value.trim().toLowerCase(); if(!q) return;
  let match = QS.find(u=>u.name.toLowerCase()===q) || QS.find(u=>u.name.toLowerCase().startsWith(q)) || QS.find(u=>u.name.toLowerCase().includes(q));
  if(match){
    selectedCountry = match.country; showCountry(match.country); updateCountryFills(); openPanel();
    requestAnimationFrame(()=>{
      const cards = document.querySelectorAll('#uniList .uni');
      for(const card of cards){
        const nameEl = card.querySelector('.uni-name');
        if(nameEl && nameEl.textContent.trim().toLowerCase() === match.name.toLowerCase()){
          card.scrollIntoView({behavior:'smooth', block:'center'});
          const original = card.style.backgroundColor;
          card.style.transition = 'background-color .6s ease';
          card.style.backgroundColor = '#FFF3C4';
          setTimeout(()=>{ card.style.backgroundColor = original || ''; }, 1200);
          break;
        }
      }
    });
  }
});

// ---- Panel open/close control ----
const appEl = document.querySelector('.app');
const toggleBtn = document.getElementById('togglePanel');
const closeBtn = document.getElementById('closePanelBtn');
function openPanel(){ appEl.classList.remove('closed'); toggleBtn.setAttribute('aria-expanded','true'); toggleBtn.style.display='none'; }
function closePanel(){ appEl.classList.add('closed'); toggleBtn.setAttribute('aria-expanded','false'); toggleBtn.style.display='block'; }
toggleBtn.addEventListener('click', openPanel);
closeBtn.addEventListener('click', closePanel);

window.addEventListener('resize', render);
render();
showCountry('United Kingdom'); // optional default
closePanel(); // start map-only
</script>
</body>
</html>
