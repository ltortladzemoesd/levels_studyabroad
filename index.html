<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Levels Academy – Europe (Screen-constant Labels)</title>

<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://unpkg.com/@mapbox/polylabel@1.1.0/polylabel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@700&display=swap" rel="stylesheet"/>

<style>
  :root{
    --sea:#BBE0F9; --land:#ffffff; --border:#cfd6dc; --hover:#ADE2D7;
    --brand:#2B445B; --ink:#0f1f29; --muted:#6b7a86;
    --t1:#23B899; --t2:#FDE200; --t3:#F66E6E;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,Arial}
  .app{display:grid;grid-template-columns:1.5fr .9fr;height:100vh}
  .map-wrap{background:var(--sea)}
  svg{width:100%;height:100%}
  .country{fill:var(--land);stroke:var(--border);stroke-width:1;cursor:pointer;transition:fill .12s ease}
  .country:hover{fill:var(--hover)}
  .country.selected{fill:var(--hover) !important;} /* stays selected */
  .label{
    fill:#333333; font-family:'Red Hat Display', ui-sans-serif, system-ui, Arial; font-weight:700;
    letter-spacing:.3px; pointer-events:none;
  }
  /* non-interactive rest of world */
  .rest{fill:#F7FAFF; stroke:var(--border); stroke-width:1}
  .panel{background:#fff;border-left:1px solid #e9eef2;display:flex;flex-direction:column}
  .panel-head{background:var(--brand);color:#fff;padding:14px 16px;display:flex;justify-content:space-between;align-items:center}
  .panel-title{font-weight:800}
  .panel-count{opacity:.9}
  .list{padding:12px;overflow:auto}
  .uni{border:1px solid #eef2f5;border-radius:14px;padding:10px 12px;margin:8px 0}
  .rank{display:inline-block;padding:2px 8px;border-radius:8px;font-weight:800;color:#fff;margin-bottom:4px}
  .rank.t1{background:#23B899} .rank.t2{background:#FDE200;color:#222} .rank.t3{background:#F66E6E}
  .uni-name{font-weight:700;color:var(--ink)} .muted{color:#6b7a86;font-size:12px}
  @media (max-width:900px){ .app{grid-template-columns:1fr;grid-template-rows:55vh 1fr} .panel{border-left:none;border-top:1px solid #e9eef2} }
</style>
</head>
<body>
<div class="app">
  <div class="map-wrap"><svg id="map" aria-label="Europe map"></svg></div>

  <aside class="panel">
    <div class="panel-head">
      <div class="panel-title" id="panelTitle">Pick a country</div>
      <div class="panel-count" id="panelCount">0 universities</div>
    </div>

    <!-- SEARCH BARS -->
    <div style="padding:10px 12px;border-bottom:1px solid #e9eef2">
      <input id="countrySearch" type="text" placeholder="Search country…" 
             style="width:100%;padding:10px 12px;border:1px solid #e5e9ee;border-radius:10px;font-size:14px;margin-bottom:8px"/>
      <input id="uniSearch" type="text" placeholder="Search university…" 
             style="width:100%;padding:10px 12px;border:1px solid #e5e9ee;border-radius:10px;font-size:14px"/>
    </div>

    <div class="list" id="uniList"></div>
  </aside>
</div>

<script>
// -------- Demo QS data (swap with your Excel extract) --------
const QS = [
  {country:'United Kingdom', euRank:2,  name:'Imperial College London'},
  {country:'United Kingdom', euRank:3,  name:'University of Oxford'},
  {country:'United Kingdom', euRank:4,  name:'University of Cambridge'},
  {country:'United Kingdom', euRank:5,  name:'UCL (University College London)'},
  {country:'United Kingdom', euRank:8,  name:"King's College London"},
  {country:'United Kingdom', euRank:12, name:'LSE – London School of Economics'},
  {country:'Switzerland',    euRank:1,  name:'ETH Zurich'},
  {country:'Switzerland',    euRank:10, name:'EPFL'},
  {country:'Germany',        euRank:11,  name:'Technical University of Munich (TUM)'},
  {country:'Germany',        euRank:18,  name:'LMU Munich'},
  {country:'France',         euRank:9,   name:'Université PSL'},
  {country:'Netherlands',    euRank:15,  name:'Delft University of Technology'},
  {country:'Netherlands',    euRank:17,  name:'University of Amsterdam'},
  {country:'Sweden',         euRank:13,  name:'Lund University'}
];
const byCountry = c => QS.filter(d=>d.country===c).sort((a,b)=>a.euRank-b.euRank);
const tier = r => r<=50?'t1':(r<=200?'t2':'t3');

// -------- Map scaffolding --------
const svg = d3.select('#map');
const gRest      = svg.append('g');     // non-interactive rest of world
const gCountries = svg.append('g');     // zoomed (scale + translate)
const gLabels    = svg.append('g');     // NOT scaled; we reposition labels manually

let projection, path;
let LABELS = [];
let selectedCountry = null;
let INTERACTIVE = [];

const EUROPE = new Set([
  "Albania","Andorra","Armenia","Azerbaijan",
  "Austria","Belarus","Belgium","Bosnia and Herz.","Bulgaria",
  "Canada",
  "Croatia","Czechia","Denmark","Estonia","Finland","France",
  "Germany","Greece","Hungary","Iceland","Ireland","Italy",
  "Kosovo","Latvia","Liechtenstein","Lithuania","Luxembourg",
  "Malta","Moldova","Monaco","Montenegro","Netherlands",
  "North Macedonia","Norway","Poland","Portugal","Romania",
  "San Marino","Serbia","Slovakia","Slovenia","Spain","Sweden",
  "Switzerland","Ukraine","United Kingdom","Vatican",
  "Georgia","Turkey","Russia","Mexico","United States of America"
]);
const NAME_FIX = new Map([
  ["Bosnia and Herz.","Bosnia & Herzegovina"],
  ["Czechia","Czech Republic"],
  ["North Macedonia","N. Macedonia"]
]);

// hide labels for these microstates only
const HIDE_LABELS = new Set(["Vatican","Kosovo","Andorra","San Marino"]);

// accurate text measuring for collision
const measure = (() => {
  const c = document.createElement('canvas'); const ctx = c.getContext('2d');
  return (text, px) => { ctx.font = `700 ${px}px ui-sans-serif, system-ui, Arial`; return ctx.measureText(text).width; };
})();

// --- Helper: Move Crimea polygons from Russia to Ukraine (UN-recognized) ---
function reassignCrimea(features){
  const uk = features.find(f => rawName(f) === 'Ukraine');
  const ru = features.find(f => rawName(f) === 'Russia');
  if(!uk || !ru || ru.geometry.type !== 'MultiPolygon') return;

  const inCrimea = poly => {
    const c = d3.geoCentroid({type:'Polygon', coordinates: poly});
    const [lon, lat] = c;
    return (lon >= 32 && lon <= 37.5 && lat >= 44 && lat <= 46.8);
  };

  const keep = [], move = [];
  for(const poly of ru.geometry.coordinates){
    (inCrimea(poly) ? move : keep).push(poly);
  }
  if(move.length === 0) return;

  // remove from Russia
  ru.geometry.coordinates = keep;

  // add to Ukraine
  if(uk.geometry.type === 'Polygon'){
    uk.geometry = {type:'MultiPolygon', coordinates:[uk.geometry.coordinates]};
  }
  uk.geometry.coordinates.push(...move);
}

// Zoom: screen-constant labels
const zoom = d3.zoom().scaleExtent([1, 9]).on('zoom', ev => {
  const t = ev.transform, k = t.k;
  gRest.attr('transform', t);       // pan/zoom rest of world
  gCountries.attr('transform', t);  // pan/zoom interactive countries
  updateLabels(k, t);
});
svg.call(zoom);

function render(){
  const w = svg.node().clientWidth, h = svg.node().clientHeight;
  projection = d3.geoMercator().center([15,53]).scale(Math.min(w,h)*0.85).translate([w/2,h/2]);
  path = d3.geoPath(projection);

  d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json").then(topology=>{
    const world = topojson.feature(topology, topology.objects.countries);

    // --- draw rest of world (non-interactive, #F7FAFF) ---
    const rest = world.features.filter(f => !EUROPE.has(rawName(f)));
    gRest.selectAll('path.rest')
      .data(rest, d=>rawName(d))
      .join('path')
      .attr('class','rest')
      .attr('d', path);

    // Interactive subset
    const features = world.features.filter(f => EUROPE.has(rawName(f)));
    INTERACTIVE = features; // for search

    // Apply UN-recognized assignment for Crimea
    reassignCrimea(features);

    // Countries
    gCountries.selectAll('path.country')
      .data(features, d=>rawName(d))
      .join('path')
      .attr('class','country')
      .attr('d', path)
      .on('click', (e,d)=> { 
        selectedCountry = displayName(d);
        showCountry(selectedCountry);
        updateCountryFills();
      })
      .on('mouseenter', function(e,d){
        if (displayName(d) !== selectedCountry) d3.select(this).attr('fill','var(--hover)');
      })
      .on('mouseleave', function(e,d){
        d3.select(this).attr('fill', displayName(d)===selectedCountry ? 'var(--hover)' : 'var(--land)');
      })
      .attr('fill','var(--land)')
      .attr('stroke','var(--border)');

    // Label anchors via polylabel (inside polygon)
    LABELS = features.map(f=>{
      const name = displayName(f);
      if (HIDE_LABELS.has(name)) return null;       // <- hide these labels
      const geom = f.geometry;
      let ll;
      try{
        if(geom.type === "Polygon") ll = polylabel(geom.coordinates, 1.0);
        else if(geom.type === "MultiPolygon"){
          let best=null, bestA=-Infinity;
          for(const poly of geom.coordinates){
            const cand = polylabel(poly, 1.0);
            const A = ringArea(poly[0]); if(A>bestA){bestA=A; best=cand;}
          }
          ll = best;
        }
      }catch(_){ ll = d3.geoCentroid(f); }
      let [x,y] = projection(ll);   // base screen coords at k=1
      if (name === 'France') { x += 80; y -= 56; }  // keep prior nudge
      return {name, feature:f, x, y};
    }).filter(Boolean);

    // Create label nodes
    gLabels.selectAll('text.label')
      .data(LABELS, d=>d.name)
      .join('text')
      .attr('class','label')
      .text(d=>d.name);

    // initial layout (k=1, identity)
    updateLabels(1, d3.zoomIdentity);
    updateCountryFills();
  });
}

function updateCountryFills(){
  gCountries.selectAll('path.country')
    .classed('selected', d => displayName(d)===selectedCountry)
    .attr('fill', d => displayName(d)===selectedCountry ? 'var(--hover)' : 'var(--land)');
}

function rawName(f){ return (f.properties && (f.properties.name || f.id)) || 'Unknown'; }
function displayName(f){ const n = rawName(f); return NAME_FIX.get(n) || n; }
function ringArea(ring){ let a=0; for(let i=0,j=ring.length-1;i<ring.length;j=i++){const [x1,y1]=ring[j],[x2,y2]=ring[i]; a+=(x1*y2-x2*y1);} return Math.abs(a/2); }

function updateLabels(k, t){
  const basePx = 17.6;
  const px = Math.max(10, basePx / k);
  const halo = Math.max(1, 3 / k);

  const sel = gLabels.selectAll('text.label')
    .style('font-size', `${px}px`)
    .style('stroke-width', `${halo}px`)
    .attr('x', d => t.applyX(d.x))
    .attr('y', d => t.applyY(d.y))
    .attr('display', null);

  const placed = [];
  sel.each(function(d){
    const el = this;
    const text = d.name;
    const w = measure(text, px);
    const h = px;
    const x = +el.getAttribute('x') - w/2;
    const y = +el.getAttribute('y') - h/2;

    const overlap = placed.some(p => !(x+w < p.x || p.x+p.w < x || y+h < p.y || p.y+p.h < y));
    if(overlap){ el.setAttribute('display','none'); return; }

    placed.push({x,y,w,h});
  });
}

// -------- Right panel --------
function showCountry(country){
  const list = byCountry(country);
  document.getElementById('panelTitle').textContent = country;
  document.getElementById('panelCount').textContent = `${list.length} ${list.length===1?'university':'universities'}`;
  document.getElementById('uniList').innerHTML = list.length ? list.map(u=>`
    <div class="uni">
      <span class="rank ${tier(u.euRank)}">#${u.euRank}</span>
      <div class="uni-name">${u.name}</div>
      <div class="muted">Rank in Europe</div>
    </div>
  `).join('') : `<div class="muted">No universities listed yet.</div>`;
}

// ---- Search handling (Enter to select) ----
const searchEl = document.getElementById('countrySearch');
searchEl.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter') return;
  const q = e.target.value.trim().toLowerCase();
  if(!q) return;
  const names = INTERACTIVE.map(d => displayName(d));
  // exact match
  let pick = names.find(n => n.toLowerCase() === q);
  // startswith
  if(!pick) pick = names.find(n => n.toLowerCase().startsWith(q));
  // includes
  if(!pick) pick = names.find(n => n.toLowerCase().includes(q));
  if(pick){
    selectedCountry = pick;
    showCountry(pick);
    updateCountryFills();
  }
});

// ---- University search (Enter to select) ----
const uniSearchEl = document.getElementById('uniSearch');
uniSearchEl.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter') return;
  const q = e.target.value.trim().toLowerCase();
  if(!q) return;
  // exact, then startswith, then includes
  let match = QS.find(u => u.name.toLowerCase() === q);
  if(!match) match = QS.find(u => u.name.toLowerCase().startsWith(q));
  if(!match) match = QS.find(u => u.name.toLowerCase().includes(q));
  if(match){
    selectedCountry = match.country;
    showCountry(match.country);
    updateCountryFills();
    // highlight and scroll to the matched university
    requestAnimationFrame(()=>{
      const cards = document.querySelectorAll('#uniList .uni');
      for(const card of cards){
        const nameEl = card.querySelector('.uni-name');
        if(nameEl && nameEl.textContent.trim().toLowerCase() === match.name.toLowerCase()){
          card.scrollIntoView({behavior:'smooth', block:'center'});
          const original = card.style.backgroundColor;
          card.style.transition = 'background-color .6s ease';
          card.style.backgroundColor = '#FFF3C4';
          setTimeout(()=>{ card.style.backgroundColor = original || ''; }, 1200);
          break;
        }
      }
    });
  }
});

window.addEventListener('resize', render);
render();
showCountry('United Kingdom'); // optional default
</script>
</body>
</html>
